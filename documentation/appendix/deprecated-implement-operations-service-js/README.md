## Implement the Operations Service

## Recap the Architecture

![](../images/easy-franchise-metering/Slide3.JPG)
TODO: update picture with a focus one

The **Operations Service** is called by the **EasyFranchise Service** and the Dashboard UI. 

As implementation language [NodeJS](https://nodejs.dev/) is used, but there is no significant reason to use **NodeJS**. If you are more familiar with Java or any other implementation language, you are free to do so when planning for you own operations services implementation. 

## Create the Application from Scratch 

> Hint: You can either create the sources by your own following the steps below or use the finals sources-files, which you can find at [source\operation-service](../../../code/metering-dashboard/source/operation-servic). When working with the final sources proceed with the chapter "Create Database User" below.

We are using the **NodeJs** Web framework [Express](http://expressjs.com/)

We only provide a draft overview how to gain the project stub. If you need a more detailed description check the Express help : [Express application generator](http://expressjs.com/en/starter/generator.html)


Steps to create the project sub

1. Create the stub project in new Operations Service project folder:
     
   ```shell
   $ npx express-generator
   ```
2. Befor you sart the services, you have to install all the **NodeJs** moduls:
   
   ```shell
   $ npm install
   ```
3. Start the servies
    
   ```shell
    $ npm start
   ```
4. Check that the server is up and running via the following URL:

   ```
   http://localhost:3000/
   ```

## Install NodeJs Driver for SAP HANA

1. As the **Operations Service** need access to the Database, the nodejs module [@sap/hana-client](https://www.npmjs.com/package/@sap/hana-client) has to be installed. Run:
   
   ```shell
   $ npm install @sap/hana-client
   ```
2. As result the [package.json](../../../code/metering-dashboard/source/operation-service/package.json) will have a new dependency. Check that its added. 

## Implement the Database Access

1. Lets first create the database access methodes. Create a new file ```services\db.js```  and copy the contend from [services/db.js](../../../code/metering-dashboard/source/operation-service/services/db.js) 

   The database connection details are configured via environment varaibles: 
   ```
   var conn_params = {
     serverNode: process.env.DB_SQL_ENDPOINT,
     UID: process.env.DB_USER,
     PWD: process.env.DB_PASSWORD,
   };
   ```
   The fuction **createDBTable** creates the Table **USERLOGININFO** if not existing. 

   The function **mergeUserLogin** persist the tenantid, user, month and year. 

   The function **getUserMetric** returns the aggegated user metric per teantid for a provided month and year.
   The below  SQL is used to select the requested data. (Read [SAP Help: SELECT Statement (Data Manipulation)](https://help.sap.com/viewer/7c78579ce9b14a669c1f3295b0d8ca16/Cloud/en-US/20fcf24075191014a89e9dc7b8408b26.html#loio20fcf24075191014a89e9dc7b8408b26) if you are unfamiliar with the sql language and or the ```GROUP BY```.)
   
   ```sql
   SELECT TENANTID, COUNT(USER) as ACTIVEUSERS FROM "USERLOGININFO" WHERE  MONTH=? AND YEAR=? GROUP BY TENANTID ORDER BY TENANTID 
   ```
2. As the database table should be created at start time the function ```createDBTable``` hast to be called. This is done in the [app.js](../../../code/metering-dashboard/source/operation-service/app.js). 
   
   Edit the ```app.js``` file and add the below code snippet where the other variables are defined:
   
   ```js
   var db=require('./services/db');
   ```

   Add the below code snippet as well to trigger the table creation at start-time:
   ```js
   db.createDBTableUserLoginInfoIfNotExisting();
   ``` 

## Implement the Rest Endpoints via Routing

The **Express** framwork uses the concept of rounts, so that you can implement Rest endpoints with the same path in one file. 

1. As we do not need the framwork-auto-garneted ```routes/users.js```  delete this file. 
2. Create a new route file and copy the contend from here: [routes/user.js](../../../code/metering-dashboard/source/operation-service/routes/user.js)

   The function ```router.put("/login", function (req, res))``` implements the user/login rest andpoint and calls the ```db.meterUserLogin(...)```

   The function ```router.get("/metric", function (req, res))``` read the UserMetric from the database. 
3. Edit the [app.js](code\metering-dashboard\source\operation-service\app.js)  
   
   Delete the sample rout ```var usersRouter = require('./routes/users')``` and replace it with the new user rout: 
   
   ```js
   var user = require('./routes/user');
   ```

   Inform the app about the new rout and delete the autogenerated for the users:
   ```js
   app.use('/user', user);
   ```

## Create Metering Database User

Before test-runing the **Operations Service**, a new database user has to be created, which will persist the metering related data. 

1. You should have already a HANA database created and know the according database admin user. Recheck chapter [Prepare](/documentation/prepare/README.md).
2. Open the **SAP HANA Database Explorer**:
   
   TODO add pictue here
3. Run the follwoing sql, after you have replaced the ```<password>``` with a concret one to create a new **EFMETERINGADMIN**: 

   ```sql
   -- Create the user and assign to the EFOPERATORS:
   CREATE USER EFMETERINGADMIN PASSWORD <password> SET USERGROUP EFOPERATORS;

   -- The password should not expire:
   ALTER USER EFMETERINGADMIN DISABLE PASSWORD LIFETIME;

   ```

## Set needed DB parameters as Environment Variables

1. The **Operations Servies** expect the database properties as environment variables:
   - **DB_SQL_ENDPOINT**: the sql Endpoint 
   - **DB_USER**: EFMETERINGADMIN 
   - **DB_PASSWORD**: the password
2. To set the above environment variables open a command window and run the blow commands: 
   
   as Windows user:
   
   ```shell
   set DB_SQL_ENDPOINT=<your sqlendpoint>
   set DB_USER=EFMETERINGADMIN
   set DB_PASSWORD=<the password of the DB_USER >
   ```
   
   as Mac or Unix users:
    ```shell
   export DB_SQL_ENDPOINT=<your sqlendpoint>
   export DB_USER=EFMETERINGADMIN
   export DB_PASSWORD=<the password of the DB_USER >
   ```

## Allow Cross-origin Resource Sharing

As the dashboard UI will call REST calls from the **Operations Service**, Cross-origin Resource Sharing should be allowed for the local run. 
We will make use of the NodeJs package [cors](https://www.npmjs.com/package/cors)

1. install the package via command 
  
   ```shell
   $ npm install cors
   ```
2. edit the ```app.js``` and add the blow code after ```var app = express();``` . The environment variable local_dev will be used to enable this feature:

   ```js
   if (process.env.local_dev === "true") {
     //When running the applicaitons local, we need to allow cros reference calls.
     //If we would not allow those calls the Dashboard UI will fail to get responses
     console.log("allow access-control-allow-credentials");
     const cors = require("cors");
     const corsOptions = {
       origin: "*",
       credentials: true, //access-control-allow-credentials:true
       optionSuccessStatus: 200,
     };
     app.use(cors(corsOptions));
   }
   ```
3. In case of running local set the environment variable **local_dev** to true:
   
   ```shell
   > set local_dev=true
   ```
   
   as Mac or Unix users:
   ```shell
   $ export local_dev=true
   ```

## Build and Start

1. Reuse the command window, where you in the previous step has defined the DB parameters as Environment Variables. 

2. Go to the source directory of your operation-service: 
   
   ```shell
   $ cd easyfranchise-day2/code/metering-dashboard/source/operation-service
   ```

3. Install the needed **NodeJs** modules.
   
   ```shell
   $ npm install
   ```
4. Start the service via command line:
 
   ```
   $npm start
   ```

5. The Server should now be up and running on. Open the below URl in a Browser: 
   
   ```
   http://localhost:3000
   ```

   You should see somthing similar to: 

   ![](../images/operations-service-running.png)

   > **Hint:** In case your server dose not start and you find somthing similar in the log as below. Check your  DB environment variables and validate that your Database is up and running.
   >
   > ``` 
   >  conn.connect(conn_params);
   >    ^
   > Error: Connect failed (invalid SERVERNODE '')
   > ``` 


## Execute the REST Calls

1. Lets fake the that a user has logged in. In the real scenario the **Easyfranchise service** will run this REST API:

   ```shell
   curl --request PUT 'http://localhost:3000/user/login' \
   --header 'Content-Type: application/json' \
   --data-raw '{
       "tenantid": "teanat1",
       "user": "Jon Smith"    
   }
   ```

   This should run without any errors and insert a new record in the database table **USERLOGININFO**.
   
2. Lets now do the metrics REST call and validate the user metric.  
   
   Replace month and year with the current date and run:
   
   ```shell
   curl --request GET 'http://localhost:3000/user/metric?year=<current year>&month=<current month as number 1 = Jan>' 
   ```

   You should get a JSON as response similar to:

   ```json
   [{ "TENANTID": "123456789-local-tenant-id", "ACTIVEUSERS": 1 }]
   ```
   Add othere users and/or othere tenants and re-run the curl. Check the resulting json.

